#!/bin/bash

DB="yago2s"
USER="yago"
HOST="postgres0.ag5.mpi-sb.mpg.de"

psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_tech_rel_sorted;"
psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_tech_rel_meta;"
psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_rel_tech_sorted;"
psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_rel_tech_meta;"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_tech_rel_sorted ( id SERIAL, yagoid TEXT, technique TEXT, predicate TEXT );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_tech_rel_sorted(yagoid, technique, predicate) (SELECT f1.id, f3.object, f1.predicate FROM yagofacts f1, yagofacts f2, yagofacts f3 WHERE f1.id=f2.subject AND f2.predicate='<extractionSource>' AND f2.id=f3.subject AND f3.predicate='<extractionTechnique>' ORDER BY f3.object, f1.predicate);"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_tech_rel_meta ( technique TEXT, predicate TEXT, first integer, last integer, count integer );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_tech_rel_meta(technique, predicate, first, last, count) SELECT technique, predicate, min(id), max(id), max(id)-min(id)+1 FROM facts_tech_rel_sorted GROUP BY technique, predicate ORDER BY technique, predicate;"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_rel_tech_sorted ( id SERIAL, yagoid TEXT, predicate TEXT, technique TEXT );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_rel_tech_sorted(yagoid, predicate, technique) (SELECT f1.id, f1.predicate, f3.object FROM yagofacts f1, yagofacts f2, yagofacts f3 WHERE f1.id=f2.subject AND f2.predicate='<extractionSource>' AND f2.id=f3.subject AND f3.predicate='<extractionTechnique>' ORDER BY f1.predicate, f3.object);"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_rel_tech_meta ( predicate TEXT, technique TEXT, first integer, last integer, count integer );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_rel_tech_meta(predicate, technique, first, last, count) SELECT predicate, technique, min(id), max(id), max(id)-min(id)+1 FROM facts_rel_tech_sorted GROUP BY predicate, technique ORDER BY predicate, technique;"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX ftrs_id_index ON facts_tech_rel_sorted(id);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX ftrm_tech_index ON facts_tech_rel_meta(technique);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX frts_id_index ON facts_rel_tech_sorted(id);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX frtm_rel_index ON facts_rel_tech_meta(predicate);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX frtm_rel_tech_index ON facts_rel_tech_meta(predicate,technique)"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE evaluation (timepoint timestamp without time zone, factid character varying(255), subject text, predicate text, object text, technique text, eval text, username text, target text);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX factid_index ON evaluation USING btree(factid );"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX rel_index ON evaluation USING btree(predicate );"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX tech_index ON evaluation USING btree(technique );"