#!/bin/bash

DB="yago2evaluation"
USER="yago"
HOST="postgres1.ag5.mpi-sb.mpg.de"

psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_tech_rel_sorted;"
psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_tech_rel_meta;"
psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_rel_tech_sorted;"
psql -a $DB -U $USER -h $HOST -c "DROP TABLE IF EXISTS facts_rel_tech_meta;"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_tech_rel_sorted ( id SERIAL, yagoid varchar(255), technique varchar(255), relation varchar(255) );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_tech_rel_sorted(yagoid, technique, relation) (SELECT f1.id, f3.arg2, f1.relation FROM facts f1, facts f2, facts f3 WHERE f1.id=f2.arg1 AND f2.relation='wasFoundIn' AND f2.id=f3.arg1 AND f3.relation='using' ORDER BY f3.arg2, f1.relation);"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_tech_rel_meta ( technique varchar(255), relation varchar(255), first integer, last integer, count integer );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_tech_rel_meta(technique, relation, first, last, count) SELECT technique, relation, min(id), max(id), max(id)-min(id)+1 FROM facts_tech_rel_sorted GROUP BY technique, relation ORDER BY technique, relation;"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_rel_tech_sorted ( id SERIAL, yagoid varchar(255), relation varchar(255), technique varchar(255) );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_rel_tech_sorted(yagoid, relation, technique) (SELECT f1.id, f1.relation, f3.arg2 FROM facts f1, facts f2, facts f3 WHERE f1.id=f2.arg1 AND f2.relation='wasFoundIn' AND f2.id=f3.arg1 AND f3.relation='using' ORDER BY f1.relation, f3.arg2);"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE facts_rel_tech_meta ( relation varchar(255), technique varchar(255), first integer, last integer, count integer );"
psql -a $DB -U $USER -h $HOST -c "INSERT INTO facts_rel_tech_meta(relation, technique, first, last, count) SELECT relation, technique, min(id), max(id), max(id)-min(id)+1 FROM facts_rel_tech_sorted GROUP BY relation, technique ORDER BY relation, technique;"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX ftrs_id_index ON facts_tech_rel_sorted(id);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX ftrm_tech_index ON facts_tech_rel_meta(technique);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX frts_id_index ON facts_rel_tech_sorted(id);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX frtm_rel_index ON facts_rel_tech_meta(relation);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX frtm_rel_tech_index ON facts_rel_tech_meta(relation,technique)"
psql -a $DB -U $USER -h $HOST -c "CREATE TABLE evaluation (timepoint timestamp without time zone, factid character varying(255), arg1 text, relation text, arg2 text, technique text, eval text, username text, target text);"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX factid_index ON evaluation USING btree(factid );"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX rel_index ON evaluation USING btree(relation );"
psql -a $DB -U $USER -h $HOST -c "CREATE INDEX tech_index ON evaluation USING btree(technique );"